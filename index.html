<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Fotos Aluche iPad</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100vh; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #slideshow { position: fixed; inset: 0; display: none; }
    #slideshow.activo { display: block; }
    .foto { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.2s; }
    .foto.activa { opacity: 1; }
    #calendario { position: fixed; inset: 0; display: none; background: #111; color: #fff; display: flex; flex-direction: column; }
    #header-cal { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #222; font-size: 20px; }
    #dias-semana { display: grid; grid-template-columns: repeat(7,1fr); text-align: center; padding: 8px; background: #181818; font-weight: bold; }
    #grid-dias { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; padding: 10px; flex: 1; overflow-y: auto; }
    .dia { padding: 12px 4px; border-radius: 8px; text-align: center; background: #222; cursor: pointer; font-size: 14px; }
    .dia.activo { background: #007AFF; }
    .dia.vacio { background: transparent; cursor: default; }
    .evento { margin-top: 4px; font-size: 11px; }
    #banner { 
      position: fixed; left: 0; right: 0; bottom: 0; 
      background: rgba(0,0,0,.95); color: #fff; padding: 12px; 
      font-size: 15px; text-align: center; z-index: 10; 
      height: 85px; line-height: 1.3; display: flex; flex-direction: column; justify-content: center;
    }
    #config { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,.9); color: #fff; padding: 12px; border-radius: 10px; font-size: 14px; z-index: 11; }
    #config.oculto { display: none; }
    button { cursor: pointer; background: #007AFF; color: white; border: none; padding: 8px 12px; border-radius: 6px; }
    input { width: 70px; padding: 4px; }
    .icono-tiempo { font-size: 18px; margin-right: 2px; }
    #status { position: fixed; top: 10px; left: 10px; background: rgba(0,122,255,.9); color: white; padding: 8px; border-radius: 6px; font-size: 12px; z-index: 12; }
    .dia:hover { background: #0056CC !important; }
  </style>
</head>
<body>
  <div id="status">Cargando Ã¡lbum fotos...</div>
  <div id="slideshow" class="activo">
    <div id="fotos-container"></div>
  </div>
  
  <!-- CALENDARIO -->
  <div id="calendario">
    <div id="header-cal">
      <button onclick="toggleCalendario()">ðŸ“…</button>
      <span id="mes-anio"></span>
      <div>
        <button onclick="mesAnterior()">&lt;</button>
        <button onclick="mesSiguiente()">&gt;</button>
      </div>
    </div>
    <div id="dias-semana">
      <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
    </div>
    <div id="grid-dias"></div>
  </div>
  
  <!-- BANNER TIEMPO -->
  <div id="banner">
    <div id="reloj">00:00</div>
    <div id="tiempo-aluche">-- Aluche -- <span id="icono-tiempo"></span> --Â°C</div>
  </div>
  
  <!-- CONFIG -->
  <div id="config">
    <div>Tiempo foto: <input id="tiempo-input" type="number" value="10" min="3" max="60">s</div>
    <button onclick="cambiarTiempo()">OK</button>
    <br><button onclick="toggleCalendario()">Calendario</button>
    <br><button onclick="toggleConfig()">X</button>
  </div>

  <script>
    // â† CONFIGURACIÃ“N
    const ALBUM_URL = 'https://photos.app.goo.gl/8FneEkAkuGG3Q66C8';
    const WEATHER_KEY = '7be48cf62294a005f85054f13ff72ea9';
    const LAT_ALUCHE = 40.3845;
    const LON_ALUCHE = -3.7280;
    
    const iconosTiempo = {
      '01d': 'â˜€ï¸', '02d': 'â›…', '03d': 'â˜ï¸', '04d': 'â˜ï¸', '09d': 'ðŸŒ¦ï¸', '10d': 'ðŸŒ§ï¸', '11d': 'â›ˆï¸', '13d': 'â„ï¸', '50d': 'ðŸŒ«ï¸',
      '01n': 'ðŸŒ™', '02n': 'â˜ï¸', '03n': 'â˜ï¸', '04n': 'â˜ï¸', '09n': 'ðŸŒ¦ï¸', '10n': 'ðŸŒ§ï¸', '11n': 'â›ˆï¸', '13n': 'â„ï¸', '50n': 'ðŸŒ«ï¸'
    };
    
    let fotos = [], indiceActual = 0, intervalo = null, tiempoFoto = 10000, modoCalendario = false;
    let mesActual = new Date().getMonth(), anioActual = new Date().getFullYear();

    // â† SCRAPER ROBUSTO CORREGIDO âœ¨
    async function cargarFotosAlbum() {
      try {
        document.getElementById('status').textContent = 'Extrayendo fotos Ã¡lbum...';
        
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(ALBUM_URL)}`;
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error(`Fetch fallÃ³: ${response.status}`);
        const html = await response.text();
        
        fotos = [];
        
        // Regex flexible AF_initDataCallback
        const matches = html.match(/AF_initDataCallback\s*\(\s*(\[.*?\])\s*,\s*['"].*?['"]\s*\);/s);
        if (matches) {
          let data;
          try {
            data = JSON.parse(matches[1]);
          } catch { throw new Error('JSON invÃ¡lido'); }
          
          const albumData = data.find(item => Array.isArray(item) && (item[0] === 85 || item[0] > 80));
          if (albumData?.[2]?.[0]?.[0]) {
            const items = albumData[2][0][0];
            for (let i = 0; i < Math.min(items.length, 50); i++) {
              const imgId = items[i]?.[1]?.[4]?.[0]?.[0];
              if (imgId) fotos.push(`https://lh3.googleusercontent.com/d/${imgId}=w1920-h1080-rw`);
            }
          }
        }
        
        // Fallback: busca URLs lh3 directas
        if (fotos.length === 0) {
          const imgMatches = html.match(/"(https:\/\/lh3\.googleusercontent\.com\/[^"]{20,})"/g);
          if (imgMatches) {
            fotos = imgMatches.slice(0,50).map(m => m.slice(1,-1).replace(/=s\d+-w\d+/,'=w1920-h1080-rw'));
          }
        }
        
        if (fotos.length === 0) throw new Error('No fotos encontradas');
        
        fotos = shuffle(fotos);
        document.getElementById('status').textContent = `âœ… ${fotos.length} fotos cargadas`;
        setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
        iniciarSlideshow();
      } catch (e) {
        console.error('Error Ã¡lbum:', e);
        document.getElementById('status').textContent = `âŒ ${e.message.slice(0,30)}... usando prueba`;
        setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
        cargarFotosPrueba();
      }
    }

    function cargarFotosPrueba() {
      fotos = shuffle([
        'https://picsum.photos/1920/1080?random=1',
        'https://picsum.photos/1920/1080?random=2',
        'https://picsum.photos/1920/1080?random=3',
        'https://picsum.photos/1920/1080?random=4',
        'https://picsum.photos/1920/1080?random=5'
      ]);
      iniciarSlideshow();
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // SLIDESHOW
    function iniciarSlideshow() {
      if (intervalo) clearInterval(intervalo);
      indiceActual = 0; mostrarFoto();
      intervalo = setInterval(siguienteFoto, tiempoFoto);
    }
    function mostrarFoto() {
      const cont = document.getElementById('fotos-container');
      cont.innerHTML = '';
      const img = document.createElement('img');
      img.src = fotos[indiceActual % fotos.length];
      img.className = 'foto activa';
      img.onerror = () => { 
        img.src = 'https://picsum.photos/1920/1080?random=' + Math.random(); 
      };
      cont.appendChild(img);
    }
    function siguienteFoto() { indiceActual++; mostrarFoto(); }

    // CALENDARIO
    function renderCalendario() {
      const fecha = new Date(anioActual, mesActual, 1);
      document.getElementById('mes-anio').textContent = fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
      
      const dias = document.getElementById('grid-dias');
      dias.innerHTML = '';
      
      const primerDia = new Date(anioActual, mesActual, 1).getDay();
      const diasMes = new Date(anioActual, mesActual + 1, 0).getDate();
      
      // DÃ­as vacÃ­os
      for (let i = 0; i < (primerDia === 0 ? 6 : primerDia - 1); i++) {
        const div = document.createElement('div');
        div.className = 'dia vacio';
        dias.appendChild(div);
      }
      
      // DÃ­as mes
      for (let dia = 1; dia <= diasMes; dia++) {
        const div = document.createElement('div');
        div.className = 'dia';
        div.textContent = dia;
        div.onclick = () => div.classList.toggle('activo');
        dias.appendChild(div);
      }
    }
    function mesAnterior() { mesActual--; if (mesActual < 0) { mesActual = 11; anioActual--; } renderCalendario(); }
    function mesSiguiente() { mesActual++; if (mesActual > 11) { mesActual = 0; anioActual++; } renderCalendario(); }
    function toggleCalendario() {
      modoCalendario = !modoCalendario;
      document.getElementById('calendario').style.display = modoCalendario ? 'flex' : 'none';
      document.getElementById('slideshow').style.display = modoCalendario ? 'none' : 'block';
      if (!modoCalendario) renderCalendario();
    }

    // TIEMPO Y RELOJ
    function actualizarReloj() {
      const ahora = new Date();
      document.getElementById('reloj').textContent = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }
    
    async function cargarTiempo() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT_ALUCHE}&lon=${LON_ALUCHE}&appid=${WEATHER_KEY}&units=metric&lang=es`;
        const res = await fetch(url);
        const data = await res.json();
        const icono = iconosTiempo[data.weather[0].icon] || 'ðŸŒ¤ï¸';
        document.getElementById('tiempo-aluche').innerHTML = `${data.name} ${icono} ${Math.round(data.main.temp)}Â°C`;
      } catch (e) {
        document.getElementById('tiempo-aluche').textContent = 'Tiempo no disponible';
      }
    }

    // CONFIG
    function cambiarTiempo() {
      const nuevoTiempo = parseInt(document.getElementById('tiempo-input').value) * 1000;
      if (nuevoTiempo >= 3000 && nuevoTiempo <= 60000) {
        tiempoFoto = nuevoTiempo;
        if (intervalo) clearInterval(intervalo);
        intervalo = setInterval(siguienteFoto, tiempoFoto);
      }
    }
    function toggleConfig() {
      document.getElementById('config').classList.toggle('oculto');
    }

    // â† INICIALIZACIÃ“N
    window.addEventListener('load', async () => {
      toggleConfig(); // Oculta config inicial
      await cargarFotosAlbum();
      renderCalendario();
      actualizarReloj();
      cargarTiempo();
      
      setInterval(actualizarReloj, 1000);
      setInterval(cargarTiempo, 600000); // 10min
    });
  </script>
</body>
</html>
