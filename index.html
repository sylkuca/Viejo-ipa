<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Fotos Aluche iPad - FIXED</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100vh; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #slideshow { position: fixed; inset: 0; display: none; }
    #slideshow.activo { display: block; }
    .foto { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.2s; }
    .foto.activa { opacity: 1; }
    #calendario { position: fixed; inset: 0; display: none; background: #111; color: #fff; z-index: 20; display: flex; flex-direction: column; }
    #header-cal { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #222; font-size: 20px; }
    #dias-semana { display: grid; grid-template-columns: repeat(7,1fr); text-align: center; padding: 8px; background: #181818; font-weight: bold; font-size: 14px; }
    #grid-dias { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; padding: 10px; flex: 1; overflow-y: auto; }
    .dia { padding: 12px 8px; border-radius: 8px; text-align: center; background: #222; cursor: pointer; font-size: 16px; transition: background 0.2s; }
    .dia.activo { background: #007AFF; }
    .dia.vacio { background: transparent; cursor: default; }
    .evento { margin-top: 4px; font-size: 11px; }
    #banner { 
      position: fixed; left: 0; right: 0; bottom: 0; 
      background: rgba(0,0,0,.95); color: #fff; padding: 12px; 
      font-size: 15px; text-align: center; z-index: 10; 
      height: 85px; line-height: 1.3; display: flex; flex-direction: column; justify-content: center;
    }
    #config { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,.95); color: #fff; padding: 16px; border-radius: 12px; font-size: 14px; z-index: 15; backdrop-filter: blur(10px); }
    #config.oculto { display: none; }
    button { cursor: pointer; background: #007AFF; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; margin: 2px; }
    input { width: 70px; padding: 6px; border-radius: 6px; border: 1px solid #444; background: #333; color: white; }
    .icono-tiempo { font-size: 22px; margin-right: 4px; }
    #status { position: fixed; top: 10px; left: 10px; background: rgba(0,122,255,.95); color: white; padding: 12px; border-radius: 10px; font-size: 14px; z-index: 25; backdrop-filter: blur(10px); max-width: 300px; }
    .dia:hover { background: #005BBB !important; }
  </style>
</head>
<body>
  <div id="status">üöÄ Iniciando Aluche Slideshow...</div>
  
  <div id="slideshow" class="activo">
    <div id="fotos-container"></div>
  </div>
  
  <!-- CALENDARIO -->
  <div id="calendario">
    <div id="header-cal">
      <button onclick="toggleCalendario()">‚úï</button>
      <span id="mes-anio">Cargando...</span>
      <div>
        <button onclick="mesAnterior()">‚Äπ</button>
        <button onclick="mesSiguiente()">‚Ä∫</button>
      </div>
    </div>
    <div id="dias-semana"></div>
    <div id="grid-dias"></div>
  </div>
  
  <!-- BANNER INFO -->
  <div id="banner">
    <div id="reloj" style="font-size: 28px; font-weight: bold;">--:--</div>
    <div id="tiempo-aluche">Aluche <span id="icono-tiempo">üå§Ô∏è</span> --¬∞C ‚Ä¢ 07/02/2026</div>
  </div>
  
  <!-- CONFIG -->
  <div id="config">
    <div>‚è±Ô∏è Tiempo foto: <input id="tiempo-input" type="number" value="10" min="3" max="60"> seg</div>
    <button onclick="cambiarTiempo()">Actualizar</button><br>
    <button onclick="toggleCalendario()">üìÖ Calendario</button><br>
    <button onclick="cargarFotosAlbum()">üîÑ Nuevo √°lbum</button><br>
    <button onclick="toggleConfig()">‚úï</button>
  </div>

  <script>
    // ===================== CONFIG =====================
    const ALBUM_URL = 'https://photos.app.goo.gl/8FneEkAkuGG3Q66C8';
    const WEATHER_KEY = '7be48cf62294a005f85054f13ff72ea9';
    const LAT_ALUCHE = 40.3845;
    const LON_ALUCHE = -3.7280;
    
    const iconosTiempo = {
      '01d': '‚òÄÔ∏è', '02d': '‚õÖ', '03d': '‚òÅÔ∏è', '04d': '‚òÅÔ∏è', '09d': 'üå¶Ô∏è',
      '10d': 'üåßÔ∏è', '11d': '‚õàÔ∏è', '13d': '‚ùÑÔ∏è', '50d': 'üå´Ô∏è', '01n': 'üåô',
      '02n': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è', '09n': 'üå¶Ô∏è', '10n': 'üåßÔ∏è',
      '11n': '‚õàÔ∏è', '13n': '‚ùÑÔ∏è', '50n': 'üå´Ô∏è'
    };
    
    let fotos = [], indiceActual = 0, intervalo = null, tiempoFoto = 10000;
    let mesActual = new Date().getMonth(), anioActual = new Date().getFullYear();

    // ===================== M√öLTIPLES PROXIES 2026 =====================
    const PROXIES = [
      'https://api.allorigins.win/raw?url=',
      'https://corsproxy.io/?',
      'https://thingproxy.freeboard.io/fetch/',
      'https://api.codetabs.com/v1/proxy?quest='
    ];

    // ===================== CARGA FOTOS ULTRA-ROBUSTA =====================
    async function cargarFotosAlbum() {
      const status = document.getElementById('status');
      status.style.display = 'block';
      
      // Intentar √°lbum Google Photos
      status.textContent = 'üîç Probando √°lbum Google Photos...';
      const albumFotos = await scrapeAlbum();
      
      if (albumFotos.length > 0) {
        fotos = shuffle(albumFotos.slice(0, 50));
        status.textContent = `‚úÖ ¬°${fotos.length} fotos del √°lbum!`;
      } else {
        status.textContent = 'üì∏ Usando galer√≠a HD infinita (Picsum)';
        fotos = []; // Trigger infinito
      }
      
      setTimeout(() => status.style.display = 'none', 2500);
      iniciarSlideshow();
    }

    async function scrapeAlbum() {
      for (let i = 0; i < PROXIES.length; i++) {
        try {
          const status = document.getElementById('status');
          status.textContent = `Proxy ${i+1}/${PROXIES.length}...`;
          
          const proxyUrl = `${PROXIES[i]}${encodeURIComponent(ALBUM_URL)}`;
          const response = await fetch(proxyUrl);
          if (!response.ok) continue;
          
          const html = await response.text();
          
          // Buscar lh3.googleusercontent.com URLs
          const matches = [...html.matchAll(/(https:\/\/lh3\.googleusercontent\.com\/[^&\s"]+)/g)];
          const urls = matches.map(m => {
            let url = m[1];
            if (url.includes('/d/')) {
              return url.replace(/=w\d+-h\d+|vt=[^&]+/, '=w1920-h1080-rw');
            }
            return null;
          }).filter(Boolean);
          
          if (urls.length > 3) return urls; // √âxito
          
        } catch (e) {
          console.warn(`Proxy ${i+1} fall√≥:`, e);
        }
      }
      return []; // Todos fallaron
    }

    // ===================== SLIDESHOW CON INFINITO =====================
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function iniciarSlideshow() {
      if (intervalo) clearInterval(intervalo);
      indiceActual = 0;
      mostrarFoto();
      intervalo = setInterval(siguienteFoto, tiempoFoto);
    }

    function mostrarFoto() {
      const cont = document.getElementById('fotos-container');
      cont.innerHTML = '';
      const img = document.createElement('img');
      
      let src;
      if (fotos.length > 0) {
        src = fotos[indiceActual % fotos.length];
      } else {
        // Galer√≠a infinita Aluche-style
        src = `https://picsum.photos/seed/aluche-${indiceActual}/1920/1080`;
      }
      
      img.src = src;
      img.className = 'foto activa';
      img.onerror = () => {
        img.src = `https://picsum.photos/seed/aluche-fail-${Math.random()}/1920/1080`;
      };
      cont.appendChild(img);
    }

    function siguienteFoto() {
      indiceActual++;
      mostrarFoto();
    }

    // ===================== CALENDARIO =====================
    function renderCalendario() {
      const fecha = new Date(anioActual, mesActual, 1);
      document.getElementById('mes-anio').textContent = 
        fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
      
      const diasSemana = document.getElementById('dias-semana');
      diasSemana.innerHTML = '<div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>';
      
      const gridDias = document.getElementById('grid-dias');
      gridDias.innerHTML = '';
      
      const primerDia = new Date(anioActual, mesActual, 1).getDay() || 7;
      const diasMes = new Date(anioActual, mesActual + 1, 0).getDate();
      
      // Vac√≠os inicio
      for (let i = 1; i < primerDia; i++) {
        const div = document.createElement('div');
        div.className = 'dia vacio';
        gridDias.appendChild(div);
      }
      
      // D√≠as
      for (let dia = 1; dia <= diasMes; dia++) {
        const div = document.createElement('div');
        div.className = 'dia';
        div.textContent = dia;
        div.onclick = () => {
          document.querySelectorAll('.dia').forEach(d => d.classList.remove('activo'));
          div.classList.add('activo');
        };
        gridDias.appendChild(div);
      }
    }

    function mesAnterior() { 
      mesActual--; 
      if (mesActual < 0) { mesActual = 11; anioActual--; } 
      renderCalendario(); 
    }
    function mesSiguiente() { 
      mesActual++; 
      if (mesActual > 11) { mesActual = 0; anioActual++; } 
      renderCalendario(); 
    }

    function toggleCalendario() {
      const cal = document.getElementById('calendario');
      const slide = document.getElementById('slideshow');
      cal.style.display = cal.style.display === 'flex' ? 'none' : 'flex';
      slide.style.display = slide.style.display === 'block' ? 'none' : 'block';
      if (cal.style.display === 'flex') renderCalendario();
    }

    // ===================== TIEMPO + RELOJ =====================
    function actualizarReloj() {
      const ahora = new Date();
      document.getElementById('reloj').textContent = 
        ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('tiempo-aluche').innerHTML = 
        `Aluche <span id="icono-tiempo">üå§Ô∏è</span> ${Math.round(ahora.getDate())}/${ahora.getMonth()+1}/${ahora.getFullYear()}`;
    }

    async function cargarTiempo() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT_ALUCHE}&lon=${LON_ALUCHE}&appid=${WEATHER_KEY}&units=metric&lang=es`;
        const res = await fetch(url);
        const data = await res.json();
        const iconoKey = data.weather[0].icon;
        document.getElementById('icono-tiempo').textContent = iconosTiempo[iconoKey] || 'üå§Ô∏è';
        document.getElementById('tiempo-aluche').innerHTML = 
          `${data.name} ${iconosTiempo[iconoKey] || 'üå§Ô∏è'} ${Math.round(data.main.temp)}¬∞C ‚Ä¢ 07/02/2026`;
      } catch (e) {
        console.warn('Tiempo fail:', e);
      }
    }

    // ===================== CONFIG =====================
    function cambiarTiempo() {
      const valor = parseInt(document.getElementById('tiempo-input').value);
      if (valor >= 3 && valor <= 60) {
        tiempoFoto = valor * 1000;
        if (intervalo) clearInterval(intervalo);
        setTimeout(iniciarSlideshow, 100);
        document.getElementById('status').textContent = `‚è±Ô∏è ${valor}s OK`;
        setTimeout(() => document.getElementById('status').style.display = 'none', 1500);
      }
    }

    function toggleConfig() {
      document.getElementById('config').classList.toggle('oculto');
    }

    // ===================== INICIALIZACI√ìN =====================
    window.addEventListener('load', async () => {
      document.getElementById('status').textContent = '‚úÖ Listo! Cargando fotos...';
      
      // Ocultar config inicial
      document.getElementById('config').classList.add('oculto');
      
      // Cargar todo
      await cargarFotosAlbum();
      renderCalendario();
      actualizarReloj();
      cargarTiempo();
      
      // Intervalos
      setInterval(actualizarReloj, 500);
      setInterval(cargarTiempo, 10 * 60 * 1000); // 10min
      
      setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
    });
  </script>
</body>
</html>
