<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fotos Calendario Aluche iPad</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100vh; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #slideshow { position: fixed; inset: 0; display: none; }
    #slideshow.activo { display: block; }
    .foto { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.2s; }
    .foto.activa { opacity: 1; }
    #calendario { position: fixed; inset: 0; display: none; background: #111; color: #fff; display: flex; flex-direction: column; }
    #header-cal { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #222; font-size: 20px; }
    #dias-semana { display: grid; grid-template-columns: repeat(7,1fr); text-align: center; padding: 8px; background: #181818; font-weight: bold; }
    #grid-dias { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; padding: 10px; flex: 1; overflow-y: auto; }
    .dia { padding: 12px 4px; border-radius: 8px; text-align: center; background: #222; cursor: pointer; font-size: 14px; }
    .dia.activo { background: #007AFF; }
    .dia.vacio { background: transparent; cursor: default; }
    .evento { margin-top: 4px; font-size: 11px; }
    #banner { 
      position: fixed; left: 0; right: 0; bottom: 0; 
      background: rgba(0,0,0,.95); color: #fff; padding: 12px; 
      font-size: 15px; text-align: center; z-index: 10; 
      height: 85px; line-height: 1.3; display: flex; flex-direction: column; justify-content: center;
    }
    #config { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,.9); color: #fff; padding: 12px; border-radius: 10px; font-size: 14px; z-index: 11; }
    #config.oculto { display: none; }
    button { cursor: pointer; background: #007AFF; color: white; border: none; padding: 8px 12px; border-radius: 6px; }
    input { width: 70px; padding: 4px; }
    .icono-tiempo { font-size: 18px; margin-right: 2px; }
  </style>
</head>
<body>
  <div id="slideshow" class="activo">
    <div id="fotos-container"></div>
  </div>
  <div id="calendario">
    <div id="header-cal">
      <button onclick="mesAnterior()">‚Äπ</button>
      <span id="mes-anio"></span>
      <button onclick="mesSiguiente()">‚Ä∫</button>
    </div>
    <div id="dias-semana">
      <span>Lun</span><span>Mar</span><span>Mi√©</span><span>Jue</span><span>Vie</span><span>S√°b</span><span>Dom</span>
    </div>
    <div id="grid-dias"></div>
  </div>
  <div id="banner">
    <div id="pronostico" style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">Cargando tiempo Aluche...</div>
    <div style="font-size: 14px;">
      <span id="reloj" style="font-weight: bold;"></span> | 
      <span id="fecha" style="font-size: 13px;"></span>
    </div>
  </div>
  <div id="config">
    Tiempo foto (s): <input id="tiempo" type="number" value="10" min="5" max="60"><br>
    <button onclick="toggleConfig()">Cerrar</button>
  </div>

  <script>
    // ‚Üê API KEY FUNCIONANDO (mant√©n la tuya si funciona)
    const WEATHER_KEY = '7be48cf62294a005f85054f13ff72ea9';
    const LAT_ALUCHE = 40.3845;
    const LON_ALUCHE = -3.7280;

    // ‚Üê ICONOS EMOJI para cada tipo de tiempo (OpenWeatherMap)
    const iconosTiempo = {
      '01d': '‚òÄÔ∏è', '01n': 'üåô',  // Clear
      '02d': '‚õÖ', '02n': '‚õÖ',  // Few clouds
      '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è',  // Clouds
      '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è',  // Broken clouds
      '09d': 'üå¶Ô∏è', '09n': 'üå¶Ô∏è', // Shower rain
      '10d': 'üåßÔ∏è', '10n': 'üåßÔ∏è', // Rain
      '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è', // Thunderstorm
      '13d': '‚ùÑÔ∏è',  '13n': '‚ùÑÔ∏è', // Snow
      '50d': 'üå´Ô∏è',  '50n': 'üå´Ô∏è'  // Mist
    };

    const fotosPrueba = [
      'https://picsum.photos/1920/1080?random=1',
      'https://picsum.photos/1920/1080?random=2',
      'https://picsum.photos/1920/1080?random=3',
      'https://picsum.photos/1920/1080?random=4',
      'https://picsum.photos/1920/1080?random=5'
    ];

    let fotos = [], indiceActual = 0, intervalo = null, tiempoFoto = 10000, modoCalendario = false, timeoutCalendario = null;
    const eventos = {
      '2026-02-10': 'Ski Formigal',
      '2026-02-15': 'Revisi√≥n ascensor',
      '2026-02-20': 'Golf'
    };

    // ‚Üê FUNCI√ìN para obtener icono por c√≥digo OpenWeatherMap
    function obtenerIcono(iconoCodigo) {
      return iconosTiempo[iconoCodigo] || 'üå§Ô∏è';
    }

    // Fotos (sin cambios)
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function cargarFotos() { fotos = shuffle([...fotosPrueba]); iniciarSlideshow(); }
    function iniciarSlideshow() {
      if (intervalo) clearInterval(intervalo);
      indiceActual = 0; mostrarFoto();
      intervalo = setInterval(siguienteFoto, tiempoFoto);
    }
    function mostrarFoto() {
      const cont = document.getElementById('fotos-container');
      cont.innerHTML = '';
      const img = document.createElement('img');
      img.src = fotos[indiceActual % fotos.length];
      img.className = 'foto activa';
      img.onerror = () => img.src = fotosPrueba[0];
      cont.appendChild(img);
    }
    function siguienteFoto() { indiceActual++; mostrarFoto(); }

    // Calendario (sin cambios)
    let fechaActual = new Date();
    function renderCalendario() {
      const mesAnio = document.getElementById('mes-anio');
      const grid = document.getElementById('grid-dias');
      const primerDia = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), 1);
      const ultimoDia = new Date(fechaActual.getFullYear(), fechaActual.getMonth() + 1, 0);
      const diasMes = ultimoDia.getDate();
      const offset = (primerDia.getDay() || 7) - 1;
      mesAnio.textContent = primerDia.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
      let html = '';
      for (let i = 0; i < offset; i++) html += '<div class="dia vacio"></div>';
      for (let d = 1; d <= diasMes; d++) {
        const key = `${fechaActual.getFullYear()}-${String(fechaActual.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const ev = eventos[key] ? `<div class="evento">${eventos[key]}</div>` : '';
        html += `<div class="dia" onclick="seleccionarDia('${key}')">${d}${ev}</div>`;
      }
      grid.innerHTML = html;
    }
    function mesAnterior() { fechaActual.setMonth(fechaActual.getMonth()-1); renderCalendario(); }
    function mesSiguiente() { fechaActual.setMonth(fechaActual.getMonth()+1); renderCalendario(); }
    function seleccionarDia(f) { alert(f + ': ' + (eventos[f] || 'Libre')); }

    function actualizarReloj() {
      const ahora = new Date().toLocaleString('es-ES', {timeZone: 'Europe/Madrid', hour: '2-digit', minute: '2-digit'});
      const fecha = new Date().toLocaleDateString('es-ES', {timeZone: 'Europe/Madrid', weekday: 'short', day: 'numeric', month: 'long'});
      document.getElementById('reloj').textContent = ahora;
      document.getElementById('fecha').textContent = fecha;
    }
    setInterval(actualizarReloj, 1000);

    // ‚Üê TIEMPO CON ICONOS EMOJI (¬°ahora con iconos en lugar de texto!)
    async function cargarTiempo() {
      try {
        const current = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${LAT_ALUCHE}&lon=${LON_ALUCHE}&appid=${WEATHER_KEY}&units=metric&lang=es`);
        const hourly = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${LAT_ALUCHE}&lon=${LON_ALUCHE}&appid=${WEATHER_KEY}&units=metric&lang=es`);
        
        if (!current.ok || !hourly.ok) throw new Error('API error');
        
        const currData = await current.json();
        const hourData = await hourly.json();
        
        // ‚Üê ICONO actual + temperatura
        const iconoActual = currData.weather[0].icon;
        const tempActual = Math.round(currData.main.temp);
        const iconoEmojiActual = obtenerIcono(iconoActual);
        
        // Pr√≥ximas 4 horas CON ICONOS
        const pr√≥ximas = hourData.list.slice(0, 4).map(item => {
          const hora = new Date(item.dt * 1000).getHours();
          const iconoHora = obtenerIcono(item.weather[0].icon);
          const tempHora = Math.round(item.main.temp);
          return `${iconoHora} ${hora}h ${tempHora}¬∞`;
        });
        
        // ‚Üê FORMATO: Icono + Temp | Icono Hora Temp | ...
        document.getElementById('pronostico').innerHTML = 
          `${iconoEmojiActual} ${tempActual}¬∞C | ${pr√≥ximas.join(' | ')}`;
          
      } catch (e) {
        console.error('Tiempo Aluche error:', e);
        document.getElementById('pronostico').textContent = 'üå§Ô∏è Aluche: Tiempo no disponible';
      }
    }

    function mostrarCalendario() {
      modoCalendario = true;
      document.getElementById('slideshow').classList.remove('activo');
      document.getElementById('slideshow').style.display = 'none';
      document.getElementById('calendario').style.display = 'flex';
      renderCalendario();
      timeoutCalendario = setTimeout(volverFotos, 10000);
    }
    function volverFotos() {
      modoCalendario = false;
      clearTimeout(timeoutCalendario);
      document.getElementById('calendario').style.display = 'none';
      document.getElementById('slideshow').style.display = 'block';
      document.getElementById('slideshow').classList.add('activo');
      iniciarSlideshow();
    }

    document.addEventListener('touchstart', (e) => {
      if (!modoCalendario) mostrarCalendario();
      else { clearTimeout(timeoutCalendario); timeoutCalendario = setTimeout(volverFotos, 10000); }
      e.preventDefault();
    }, {passive: false});

    document.getElementById('tiempo').onchange = function() {
      tiempoFoto = parseInt(this.value) * 1000;
      if (!modoCalendario) iniciarSlideshow();
    };
    function toggleConfig() {
      document.getElementById('config').classList.toggle('oculto');
    }

    window.addEventListener('load', () => {
      document.getElementById('slideshow').style.display = 'block';
      document.getElementById('calendario').style.display = 'none';
      document.getElementById('config').classList.add('oculto');
      cargarFotos();
      actualizarReloj();
      cargarTiempo();
      setInterval(cargarTiempo, 1800000); // 30min
    });
  </script>
</body>
</html>
