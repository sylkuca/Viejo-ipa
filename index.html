<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì∏ Fotos Aluche + Tiempo iPad</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100vh; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #slideshow { position: fixed; inset: 0; display: none; }
    #slideshow.activo { display: block; }
    .foto { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.2s; }
    .foto.activa { opacity: 1; }
    #calendario { position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: white; display: none; flex-direction: column; z-index: 10; }
    #calendario.activo { display: flex; }
    #header-cal { display: flex; justify-content: space-between; padding: 20px; background: rgba(0,122,255,0.2); }
    #mes-ano { font-size: 24px; font-weight: bold; }
    #btn-cerrar { background: none; border: none; color: white; font-size: 28px; cursor: pointer; }
    #grid-dias { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; padding: 20px; flex: 1; overflow-y: auto; }
    .dia { padding: 16px 8px; border-radius: 12px; text-align: center; background: #333; cursor: pointer; font-size: 16px; transition: all 0.2s; }
    .dia.activo { background: #007AFF; color: white; }
    .evento { margin-top: 4px; font-size: 12px; color: #ccc; }
    #config { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 12px; font-size: 14px; z-index: 20; display: none; }
    #config.activo { display: block; }
    /* ‚Üê BANNER NUEVO: RELOJ IZQ, TIEMPO CENTRO */
    #banner { 
      position: fixed; bottom: 0; left: 0; right: 0; 
      background: linear-gradient(transparent, rgba(0,0,0,0.95)); 
      color: white; height: 80px; display: flex; align-items: center; 
      padding: 0 20px; font-size: 16px; z-index: 5;
      justify-content: space-between;
    }
    #reloj { flex: 1; text-align: left; font-weight: bold; font-size: 18px; order: 1; }
    #tiempo-madrid { flex: 2; text-align: center; font-size: 18px; font-weight: bold; order: 2; }
    #tiempo-detalle { flex: 1; text-align: right; font-size: 14px; opacity: 0.8; order: 3; }
    #status { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.9); color: #00FF00; padding: 20px; border-radius: 12px; z-index: 30; }
    input { background: #444; color: white; border: 1px solid #666; padding: 8px; border-radius: 6px; width: 100%; margin: 5px 0; }
    button { background: #007AFF; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin: 5px 0; }
  </style>
</head>
<body>
  <div id="slideshow">
    <img src="" class="foto activa" id="foto-actual">
  </div>
  
  <div id="calendario">
    <div id="header-cal">
      <div id="mes-ano">Febrero 2026</div>
      <button id="btn-cerrar">‚úï</button>
    </div>
    <div id="grid-dias"></div>
  </div>
  
  <div id="config">
    <div>Tiempo foto (s): <input type="number" id="tiempo-foto" value="10" min="5" max="60"></div>
    <div>Calendar ID: <input type="text" id="calendar-id" placeholder="tucorreo@gmail.com"></div>
    <button onclick="guardarConfig()">Guardar</button>
  </div>
  
  <div id="banner">
    <div id="reloj"></div>
    <div id="tiempo-madrid"></div>
    <div id="tiempo-detalle"></div>
  </div>
  
  <div id="status">Iniciando...</div>

  <script>
    const ALBUM_URL = 'https://photos.app.goo.gl/8FneEkAkuGG3Q66C8';
    const WEATHER_KEY = '061eaa539b2f8f2eecfa8836f7a48c34';
    const ALuche_LAT = 40.393, ALuche_LON = -3.756;
    let fotos = [], indiceFoto = 0, timerFoto, calendarioTimer, calendarioAbierto = false;
    let calendarId = localStorage.getItem('calendarId') || '';

    function fotoAleatoria() { return `https://picsum.photos/1920/1080?random=${Math.random()}`; }

    async function cargarFotosAlbum() {
      try {
        document.getElementById('status').textContent = 'Extrayendo fotos √°lbum...';
        const proxy = 'https://api.allorigins.win/raw?url=';
        const res = await fetch(proxy + encodeURIComponent(ALBUM_URL));
        const html = await res.text();
        const matches = html.match(/"(https:\/\/lh3\\.googleusercontent\\.com[^"]+="(?:w|d)[0-9]+[^"]+)"/g) || [];
        fotos = matches.slice(0,50).map(m => m.slice(1,-1).split('"')[0]);
        if (fotos.length) document.getElementById('status').textContent = `¬°${fotos.length} fotos!`;
        else throw new Error();
      } catch(e) {
        document.getElementById('status').textContent = 'Gal. infinita';
        fotos = [];
      }
    }

    function siguienteFoto() {
      const img = document.getElementById('foto-actual');
      img.style.opacity = '0';
      setTimeout(() => {
        img.src = fotos.length ? fotos[indiceFoto++] || fotos[indiceFoto = 0] : fotoAleatoria();
        img.style.opacity = '1';
      }, 600);
    }

    function cargarFotos() {
      cargarFotosAlbum().then(() => {
        siguienteFoto();
        clearInterval(timerFoto);
        timerFoto = setInterval(siguienteFoto, (localStorage.getItem('tiempoFoto') || 10000));
      });
    }

    function actualizarReloj() {
      const ahora = new Date();
      document.getElementById('reloj').textContent = ahora.toLocaleTimeString('es-ES', {hour12: false}) + '\n' + ahora.toLocaleDateString('es-ES', {weekday: 'short', day: 'numeric', month: 'short'});
    }

   async function cargarTiempo() {
  try {
    // Tiempo actual para franja pr√≥xima
    const ahora = new Date();
    const horaProx = ahora.getHours() + 1; // Siguiente hora (21:23 ‚Üí 22:00)
    
    // Forecast cada 3h ‚Üí encuentra m√°s cercana
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${ALuche_LAT}&lon=${ALuche_LON}&appid=${WEATHER_KEY}&units=metric&lang=es`);
    const data = await res.json();
    
    if (data.list && data.list.length) {
      // Encuentra forecast hora m√°s cercana a pr√≥xima
      const horaProxForecast = data.list.find(item => {
        const dt = new Date(item.dt * 1000).getHours();
        return Math.abs(dt - horaProx) <= 1 || dt === horaProx; // ¬±1h o exacto
      }) || data.list[0]; // Fallback primer forecast
      
      const iconos = {'Clear':'‚òÄÔ∏è','Clouds':'‚òÅÔ∏è','Rain':'üåßÔ∏è','Snow':'‚ùÑÔ∏è','Thunderstorm':'‚õàÔ∏è','Drizzle':'üå¶Ô∏è'};
      const ico = iconos[horaProxForecast.weather[0].main] || 'üå§Ô∏è';
      
      document.getElementById('tiempo-madrid').textContent = 
        `Aluche: ${Math.round(horaProxForecast.main.temp)}¬∞C ${ico}`;
      document.getElementById('tiempo-detalle').innerHTML = 
        `${horaProxForecast.weather[0].description}<br>${new Date(horaProxForecast.dt * 1000).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}`;
    } else {
      // Fallback current weather
      const resCurrent = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${ALuche_LAT}&lon=${ALuche_LON}&appid=${WEATHER_KEY}&units=metric&lang=es`);
      const current = await resCurrent.json();
      const ico = 'üå§Ô∏è';
      document.getElementById('tiempo-madrid').textContent = `Aluche: ${Math.round(current.main.temp)}¬∞C ${ico}`;
      document.getElementById('tiempo-detalle').textContent = current.weather[0].description;
    }
  } catch(e) {
    document.getElementById('tiempo-madrid').textContent = 'Aluche: --¬∞C';
    document.getElementById('tiempo-detalle').textContent = 'Error API';
    console.error('Tiempo error:', e);
  }
}

    async function generarCalendario() {
      // C√≥digo calendario igual que antes (omitido por brevedad, copia del anterior)
      const grid = document.getElementById('grid-dias');
      // ... (mismo c√≥digo generarCalendario del mensaje previo)
    }

    function guardarConfig() {
      localStorage.setItem('tiempoFoto', document.getElementById('tiempo-foto').value * 1000);
      localStorage.setItem('calendarId', document.getElementById('calendar-id').value);
      document.getElementById('config').classList.remove('activo');
      cargarFotos(); generarCalendario();
    }

    // Eventos (igual que antes)
    window.addEventListener('load', () => {
      document.getElementById('slideshow').classList.add('activo');
      document.getElementById('status').style.display = 'block';
      document.getElementById('tiempo-foto').value = (localStorage.getItem('tiempoFoto') || 10000)/1000;
      document.getElementById('calendar-id').value = calendarId;
      // ... (mismos eventos del c√≥digo previo)
      cargarFotos(); actualizarReloj(); cargarTiempo();
      setInterval(actualizarReloj, 1000); setInterval(cargarTiempo, 30*60*1000);
      setTimeout(() => document.getElementById('status').style.display = 'none', 4000);
    });
  </script>
</body>
</html>

