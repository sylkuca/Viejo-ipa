<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì∏ Fotos Aluche + Tiempo iPad</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100vh; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #slideshow { position: fixed; inset: 0; display: none; }
    #slideshow.activo { display: block; }
    .foto { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.2s; }
    .foto.activa { opacity: 1; }
    #calendario { position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: white; display: none; flex-direction: column; z-index: 10; }
    #calendario.activo { display: flex; }
    #header-cal { display: flex; justify-content: space-between; padding: 20px; background: rgba(0,122,255,0.2); }
    #mes-ano { font-size: 24px; font-weight: bold; }
    #btn-cerrar { background: none; border: none; color: white; font-size: 28px; cursor: pointer; }
    #grid-dias { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; padding: 20px; flex: 1; overflow-y: auto; }
    .dia { padding: 16px 8px; border-radius: 12px; text-align: center; background: #333; cursor: pointer; font-size: 16px; transition: all 0.2s; }
    .dia.activo { background: #007AFF; color: white; }
    .evento { margin-top: 4px; font-size: 12px; color: #ccc; }
    #config { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 12px; font-size: 14px; z-index: 20; display: none; }
    #config.activo { display: block; }
    #banner { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: white; padding: 20px; font-size: 16px; text-align: center; line-height: 1.4; height: 80px; display: flex; flex-direction: column; justify-content: center; }
    #status { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.9); color: #00FF00; padding: 20px; border-radius: 12px; z-index: 30; }
    input { background: #444; color: white; border: 1px solid #666; padding: 8px; border-radius: 6px; width: 100%; margin: 5px 0; }
    button { background: #007AFF; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin: 5px 0; }
  </style>
</head>
<body>
  <div id="slideshow">
    <img src="" class="foto activa" id="foto-actual">
  </div>
  
  <div id="calendario">
    <div id="header-cal">
      <div id="mes-ano">Febrero 2026</div>
      <button id="btn-cerrar">‚úï</button>
    </div>
    <div id="grid-dias"></div>
  </div>
  
  <div id="config">
    <div>Tiempo foto (s): <input type="number" id="tiempo-foto" value="10" min="5" max="60"></div>
    <div>Calendar ID: <input type="text" id="calendar-id" placeholder="tucorreo@gmail.com"></div>
    <button onclick="guardarConfig()">Guardar</button>
  </div>
  
  <div id="banner">
    <div id="reloj"></div>
    <div id="tiempo-madrid"></div>
  </div>
  
  <div id="status">Iniciando...</div>

  <script>
    const ALBUM_URL = 'https://photos.app.goo.gl/8FneEkAkuGG3Q66C8';
    const WEATHER_KEY = '061eaa539b2f8f2eecfa8836f7a48c34'; // Tu clave
    const ALuche_LAT = 40.393, ALuche_LON = -3.756;
    let fotos = [], indiceFoto = 0, timerFoto, calendarioTimer, calendarioAbierto = false;
    let calendarId = localStorage.getItem('calendarId') || '';

    // Fotos fallback infinitas
    function fotoAleatoria() {
      return `https://picsum.photos/1920/1080?random=${Math.random()}`;
    }

    async function cargarFotosAlbum() {
      try {
        document.getElementById('status').textContent = 'Extrayendo fotos √°lbum...';
        const proxy = 'https://api.allorigins.win/raw?url=';
        const res = await fetch(proxy + encodeURIComponent(ALBUM_URL));
        const html = await res.text();
        const matches = html.match(/"(https:\/\/lh3\\.googleusercontent\\.com[^"]+="(?:w|d)[0-9]+[^"]+)"/g) || [];
        fotos = matches.slice(0,50).map(m => m.slice(1,-1).split('"')[0]);
        if (fotos.length) {
          document.getElementById('status').textContent = `¬°${fotos.length} fotos cargadas!`;
        } else throw new Error();
      } catch(e) {
        document.getElementById('status').textContent = 'Usando galer√≠a infinita';
        fotos = []; // Usar fallback
      }
    }

    function siguienteFoto() {
      const img = document.getElementById('foto-actual');
      img.style.opacity = '0';
      setTimeout(() => {
        if (fotos.length) {
          img.src = fotos[indiceFoto];
          indiceFoto = (indiceFoto + 1) % fotos.length;
        } else {
          img.src = fotoAleatoria();
        }
        img.style.opacity = '1';
      }, 600);
    }

    function cargarFotos() {
      cargarFotosAlbum().then(() => {
        siguienteFoto();
        timerFoto = setInterval(siguienteFoto, parseInt(localStorage.getItem('tiempoFoto') || 10000));
      });
    }

    function actualizarReloj() {
      const ahora = new Date();
      document.getElementById('reloj').textContent = ahora.toLocaleTimeString('es-ES', {hour12: false}) + ' ' + ahora.toLocaleDateString('es-ES', {weekday: 'short'});
    }

    async function cargarTiempo() {
      try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${ALuche_LAT}&lon=${ALuche_LON}&appid=${WEATHER_KEY}&units=metric&lang=es`);
        const data = await res.json();
        const iconos = { 'Clear': '‚òÄÔ∏è', 'Clouds': '‚òÅÔ∏è', 'Rain': 'üåßÔ∏è', 'Snow': '‚ùÑÔ∏è', 'Thunderstorm': '‚õàÔ∏è' };
        const ico = iconos[data.weather[0].main] || 'üå§Ô∏è';
        document.getElementById('tiempo-madrid').textContent = `Aluche: ${Math.round(data.main.temp)}¬∞C ${data.weather[0].description} ${ico}`;
      } catch(e) {
        document.getElementById('tiempo-madrid').textContent = 'Aluche: Tiempo no disponible';
      }
    }

    async function generarCalendario() {
      const grid = document.getElementById('grid-dias');
      const hoy = new Date();
      const mes = hoy.getMonth(), year = hoy.getFullYear();
      const primerDia = new Date(year, mes, 1).getDay();
      const diasMes = new Date(year, mes + 1, 0).getDate();
      grid.innerHTML = '';

      for (let i = 0; i < primerDia; i++) {
        const div = document.createElement('div'); div.className = 'dia vacio'; grid.appendChild(div);
      }
      for (let dia = 1; dia <= diasMes; dia++) {
        const div = document.createElement('div'); div.className = 'dia'; div.textContent = dia;
        if (dia === hoy.getDate() && mes === hoy.getMonth()) div.classList.add('activo');
        grid.appendChild(div);
      }

      if (calendarId) {
        try {
          const res = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=AIzaSyB...&timeMin=${new Date().toISOString()}`);
          const data = await res.json();
          // Procesar eventos (simplificado)
        } catch(e) {
          console.log('Calendar API error, usando b√°sico:', e);
        }
      }
    }

    function guardarConfig() {
      localStorage.setItem('tiempoFoto', document.getElementById('tiempo-foto').value * 1000);
      localStorage.setItem('calendarId', document.getElementById('calendar-id').value);
      document.getElementById('config').classList.remove('activo');
      cargarFotos(); generarCalendario();
    }

    window.addEventListener('load', () => {
      document.getElementById('slideshow').classList.add('activo');
      document.getElementById('status').style.display = 'block';
      
      // Config inputs
      document.getElementById('tiempo-foto').value = (localStorage.getItem('tiempoFoto') || 10000)/1000;
      document.getElementById('calendar-id').value = calendarId;
      
      // Eventos
      document.getElementById('btn-cerrar').onclick = () => { calendarioAbierto = false; document.getElementById('calendario').classList.remove('activo'); };
      document.body.onclick = (e) => {
        if (e.target.id === 'slideshow' || e.target.tagName === 'IMG') {
          calendarioAbierto = true;
          document.getElementById('calendario').classList.add('activo');
          generarCalendario();
          clearTimeout(calendarioTimer);
          calendarioTimer = setTimeout(() => {
            document.getElementById('calendario').classList.remove('activo');
            calendarioAbierto = false;
          }, 10000);
        }
        if (e.target.closest('#config')) return;
        document.getElementById('config').classList.remove('activo');
      };
      document.getElementById('slideshow').addEventListener('click', (e) => e.stopPropagation());
      
      // Iniciar
      cargarFotos();
      actualizarReloj(); cargarTiempo();
      setInterval(actualizarReloj, 1000);
      setInterval(cargarTiempo, 10*60*1000);
      
      setTimeout(() => document.getElementById('status').style.display = 'none', 4000);
    });
  </script>
</body>
</html>


