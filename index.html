<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fotos + Calendario Madrid</title>
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Fotos Calendario',
        'short_name': 'FotosCal',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#000',
        'theme_color': '#000'
    }">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: black; overflow: hidden; height: 100vh; }
        #slideshow, #calendario { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; }
        #slideshow.activo, #calendario.activo { display: block; }
        .foto { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s; }
        .foto.activa { opacity: 1; }
        #banner { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 8px; text-align: center; font-size: 16px; z-index: 100; }
        #barra { background: rgba(0,0,0,0.9); padding: 10px; text-align: center; font-size: 20px; }
        /* Calendario */
        #calendario { background: #1a1a1a; color: white; display: flex; flex-direction: column; }
        #header-cal { display: flex; justify-content: space-between; padding: 20px; font-size: 24px; }
        #dias-semana { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 10px; font-weight: bold; }
        #grid-dias { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 0 20px 100px; }
        .dia { padding: 20px 5px; text-align: center; cursor: pointer; border-radius: 8px; transition: background 0.3s; }
        .dia:hover, .dia.activo { background: #007AFF; }
        .dia.vacio { color: #666; }
        .evento { font-size: 12px; margin-top: 2px; }
        #config { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 10px; z-index: 200; }
        input, select, button { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
        button { background: #007AFF; color: white; cursor: pointer; }
        .oculto { display: none !important; }
    </style>
</head>
<body>
    <div id="slideshow"></div>
    <div id="calendario">
        <div id="header-cal">
            <button onclick="mesAnterior()">&lt;</button>
            <span id="mes-anio"></span>
            <button onclick="mesSiguiente()">&gt;</button>
        </div>
        <div id="dias-semana">
            <span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span><span>Dom</span>
        </div>
        <div id="grid-dias"></div>
    </div>
    <div id="banner">
        <span id="pronostico"></span> | <span id="reloj"></span> | <span id="fecha"></span>
    </div>
    <div id="config">
        Tiempo foto (s): <input id="tiempo" type="number" value="10" min="1"><br>
        Efecto: <select id="efecto"><option>fade</option><option>instant</option></select><br>
        <button onclick="cargarFotos()">Refresh Fotos</button>
        <button onclick="toggleConfig()">X</button>
    </div>

    <script>
        // === CONFIG ===
        const API_KEY_DRIVE = 'AIzaSyDhovxf0Fz9b5KfmCKzOGH3NuWfjGeByrY';
        const CARPETA_ID = 'https://photos.app.goo.gl/8FneEkAkuGG3Q66C8';
        const WEATHER_KEY = '061eaa539b2f8f2eecfa8836f7a48c34'; // openweathermap.org
        const LAT_MADRID = 40.4168; const LON_MADRID = -3.7038;
        
        let fotos = []; let indiceActual = 0; let intervaloFotos;
        let tiempoFoto = 10000; let fotosMostradas = 0;
        let usadas = new Set();
        let timeoutCalendario; let modoCalendario = false;

        // EVENTOS EJEMPLO (edita aquí)
        const eventos = {
            '2026-02-10': 'Ski Formigal',
            '2026-02-15': 'Revisión ascensor',
            '2026-02-20': 'Golf'
        };

        // === RELOJ MADRID ===
        function actualizarReloj() {
            const ahora = new Date().toLocaleString('es-ES', { timeZone: 'Europe/Madrid', hour: '2-digit', minute: '2-digit' });
            const fecha = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid', weekday: 'short', day: 'numeric', month: 'short' });
            document.getElementById('reloj').textContent = ahora;
            document.getElementById('fecha').textContent = fecha;
        }
        setInterval(actualizarReloj, 1000); actualizarReloj();

        // === PRONÓSTICO POR HORAS ===
        async function cargarPronostico() {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${LAT_MADRID}&lon=${LON_MADRID}&appid=${WEATHER_KEY}&units=metric&lang=es`);
                const data = await res.json();
                const hoy = new Date().toISOString().split('T')[0];
                const horasHoy = data.list.filter(h => h.dt_txt.startsWith(hoy)).slice(0,6).map(h => 
                    `${h.dt_txt.split(' ')[1].slice(0,5)}: ${Math.round(h.main.temp)}°C ${h.weather[0].description}`
                ).join(' | ');
                document.getElementById('pronostico').textContent = horasHoy;
            } catch(e) { console.error('Weather error:', e); }
        }
        cargarPronostico(); setInterval(cargarPronostico, 30*60*1000); // Cada 30min

        // === FOTOS DRIVE ===
        async function cargarFotos() {
            try {
                const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${CARPETA_ID}'%20in%20parents%20and%20trashed=false&key=${API_KEY_DRIVE}`);
                const data = await res.json();
                fotos = data.files.filter(f => /\.(jpg|jpeg|png)$/i.test(f.name))
                                  .map(f => `https://drive.google.com/uc?id=${f.id}`);
                usadas.clear(); shuffle(fotos);
                iniciarSlideshow();
            } catch(e) { console.error('Drive error:', e); }
        }

        function shuffle(array) { /* Fisher-Yates igual que antes */ 
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function iniciarSlideshow() {
            if (intervaloFotos) clearInterval(intervaloFotos);
            mostrarFoto();
            intervaloFotos = setInterval(siguienteFoto, tiempoFoto);
        }

        function mostrarFoto() {
            const slideshow = document.getElementById('slideshow');
            slideshow.innerHTML = '';
            const img = document.createElement('img');
            img.src = fotos[indiceActual];
            img.className = 'foto activa';
            slideshow.appendChild(img);
            fotosMostradas++;
            if (fotosMostradas % 10 === 0) mostrarCalendario(); // Cada 10 fotos
        }

        function siguienteFoto() {
            indiceActual = (indiceActual + 1) % fotos.length;
            if (indiceActual === 0) { shuffle(fotos); usadas.clear(); }
            mostrarFoto();
        }

        // === CALENDARIO ===
        let fechaActual = new Date();
        function renderCalendario() {
            const mesAnio = document.getElementById('mes-anio');
            const gridDias = document.getElementById('grid-dias');
            const primerDia = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), 1);
            const ultimoDia = new Date(fechaActual.getFullYear(), fechaActual.getMonth() + 1, 0);
            const diasMes = ultimoDia.getDate();
            const offset = primerDia.getDay() || 7; // Lun=1

            mesAnio.textContent = primerDia.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();

            let html = '';
            // Días vacíos
            for (let i = 1; i < offset; i++) html += '<div class="dia vacio"></div>';
            // Días mes
            for (let dia = 1; dia <= diasMes; dia++) {
                const fechaKey = `${fechaActual.getFullYear()}-${String(fechaActual.getMonth()+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
                const evento = eventos[fechaKey] ? `<div class="evento">${eventos[fechaKey]}</div>` : '';
                html += `<div class="dia" onclick="seleccionarDia('${fechaKey}')">${dia}${evento}</div>`;
            }
            gridDias.innerHTML = html;
        }

        function mesAnterior() { fechaActual.setMonth(fechaActual.getMonth() - 1); renderCalendario(); }
        function mesSiguiente() { fechaActual.setMonth(fechaActual.getMonth() + 1); renderCalendario(); }
        function seleccionarDia(fecha) { alert(`Evento: ${eventos[fecha] || 'Libre'}`); } // Expande aquí

        // === GESTIÓN MODOS ===
        function mostrarCalendario() {
            modoCalendario = true;
            document.getElementById('slideshow').classList.remove('activo');
            document.getElementById('calendario').classList.add('activo');
            renderCalendario();
            timeoutCalendario = setTimeout(volverFotos, 30000); // 30s
        }

        function volverFotos() {
            modoCalendario = false;
            clearTimeout(timeoutCalendario);
            document.getElementById('calendario').classList.remove('activo');
            document.getElementById('slideshow').classList.add('activo');
        }

        // Toque pantalla
        document.addEventListener('touchstart', (e) => {
            if (!modoCalendario) mostrarCalendario();
            else clearTimeout(timeoutCalendario), timeoutCalendario = setTimeout(volverFotos, 30000);
            e.preventDefault();
        });

        // Swipe calendario (opcional)
        let startX;
        document.getElementById('calendario').addEventListener('touchstart', e => startX = e.touches[0].clientX);
        document.getElementById('calendario').addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            if (startX - endX > 50) mesSiguiente();
            if (endX - startX > 50) mesAnterior();
        });

        // CONFIG (igual que antes)
        document.getElementById('tiempo').onchange = function() {
            tiempoFoto = parseInt(this.value) * 1000; clearInterval(intervaloFotos); iniciarSlideshow();
        };
        function toggleConfig() { document.getElementById('config').classList.toggle('oculto'); }

        // INICIO
        cargarFotos();
    </script>
</body>
</html>
